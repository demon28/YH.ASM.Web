
@{
    ViewData["Title"] = "Index";
}
@section Htmlhead{


    <style>

        .my-td {
            vertical-align: middle !important;
            text-align: center;
        }
    </style>


}
@section Pageheader{


    <script>

        function closeWui() {
            $(".wui-masked").hide();
            $('.wui-ilayout').animate({ width: '0' }, function () {
                $(".wui-ilayout iframe").attr("src", "about:blank");
            });
        }
        function showWui(uri, width) {
            var window_width = width || ($(window).width() / 2);
            $(".wui-masked").show();
            $(".wui-ilayout").show().animate({ width: window_width }, function () {
                var html = $("<div class='wui-ilayout-loading'><i class='icon-spin icon-spinner'></i>正在加载页面...</div>");
                $(".wui-ilayout iframe").before(html);
                $(".wui-ilayout iframe").attr('src', uri);
            });
        }

    </script>

    <h1>
        <small> 问题追踪</small>
    </h1>
    <ol class="breadcrumb">
        <li><a href="#"><i class="fa fa-dashboard"></i> Home</a></li>
        <li class="active">Support</li>
    </ol>

}






<section class="content">
    <div class="row">

        <!-- /.col -->
        <div id="tab_account">
            <div class="box box-primary">
                <div class="box-header">
                    <h3 class="box-title">List</h3>

                    <div class="box-tools">

                        <div class="input-group input-group-sm  col-md-1 pull-right ml-1" style="margin-left:10px;">
                            <button type="button" class="btn btn-default pull-right  btn-sm" @@click="Add()" id="btn_Add">创建工单</button>
                        </div>

                        <div class="input-group input-group-sm  col-md-1 pull-right ml-1" style="margin-left:10px;">
                            <button type="button" class="btn btn-default pull-right  btn-sm" @@click="ExportExcel()" id="btn_Search">导出Excel</button>
                        </div>



                        <div class="input-group input-group-sm  col-md-1 pull-right ml-1" style="margin-left:10px; width:150px;">
                            <select class="form-control" id="txt_types" v-model="watchType" @@change="Init()">
                                <option value="0" checked="true">全部</option>
                                <option value="1" >我创建的</option>
                                <option value="2" >我处理的</option>
                            </select>
                        </div>

                        <div class="input-group input-group-sm  col-md-2 pull-right ml-1" style="margin-left: 10px; width: 150px;">
                            <input type="text" name="table_search" class="form-control pull-right" placeholder="Search" id="txt_Search" />

                            <div class="input-group-btn">
                                <button type="button" class="btn btn-default " @@click="Search()" id="btn_Search"><i class="fa fa-search"></i></button>
                            </div>

                        </div>


                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body table-responsive no-padding">

                    <span style="display:none" id="sp_userid"></span>
                    <span style="display:none" id="sp_username"></span>
                    <table class="table table-bordered table-hover dataTable">
                        <tbody>
                            <tr>
                                <th class="my-td ">ID</th>
                                <th class="my-td ">标题</th>

                                <th class="my-td ">创建人</th>
                                <th class="my-td ">处理人</th>

                                <th class="my-td ">项目名称</th>
                                <th class="my-td ">问题类型</th>

                                <th class="my-td ">严重程度</th>
                                <th class="my-td ">优先级</th>

                                <th class="my-td ">工单状态</th>
                                <th class="my-td ">创建时间</th>
                                <th class="my-td ">操作</th>
                            </tr>




                            <tr v-for="(item,index) in list">
                                <td class="my-td ">{{item.SID}}</td>
                                <td class="my-td ">
                                    <a @@click="View(item)">
                                        {{item.TITLE}}
                                    </a>
                                </td>

                                <td class="my-td ">{{item.CREATORNAME}}</td>
                                <td class="my-td " >

                                    <a  @@click="ChangeUser(item)">
                                        {{item.CONDUCTORNAME}}
                                        </a>

                                </td>

                                <td class="my-td ">{{item.PROJECTNAME}}</td>
                                <td class="my-td ">
                                    <a @@click="ChangeType(item.TYPE,item)">{{SetType(item.TYPE)}}</a>

                                </td>

                                <td class="my-td ">
                                    <small class="label  bg-black" v-if="item.SEVERITY==0" @@click="ChangeSeverity(item.SEVERITY,item)"> {{SetSeverity(item.SEVERITY)}}</small>
                                    <small class="label  bg-red" v-if="item.SEVERITY==1" @@click="ChangeSeverity(item.SEVERITY,item)"> {{SetSeverity(item.SEVERITY)}}</small>
                                    <small class="label  bg-yellow" v-if="item.SEVERITY==2" @@click="ChangeSeverity(item.SEVERITY,item)"> {{SetSeverity(item.SEVERITY)}}</small>
                                    <small class="label  bg-gray" v-if="item.SEVERITY==3" @@click="ChangeSeverity(item.SEVERITY,item)"> {{SetSeverity(item.SEVERITY)}}</small>
                                    <small class="label  bg-blue" v-if="item.SEVERITY==4" @@click="ChangeSeverity(item.SEVERITY,item)"> {{SetSeverity(item.SEVERITY)}}</small>

                                </td>
                                <td class="my-td ">

                                    <small class="label  text-red" v-if="item.PRIORITY==0" @@click="ChangePriority(item.PRIORITY,item)"> ·{{SetPriority(item.PRIORITY)}}</small>
                                    <small class="label  text-yellow" v-if="item.PRIORITY==1" @@click="ChangePriority(item.PRIORITY,item)">·{{SetPriority(item.PRIORITY)}}</small>
                                    <small class="label  text-aqua" v-if="item.PRIORITY==2" @@click="ChangePriority(item.PRIORITY,item)"> ·{{SetPriority(item.PRIORITY)}}</small>
                                    <small class="label  text-blue" v-if="item.PRIORITY==3" @@click="ChangePriority(item.PRIORITY,item)"> ·{{SetPriority(item.PRIORITY)}}</small>
                                </td>

                                <td class="my-td ">

                                    <span class="badge bg-light-blue" @@click="ChangeStatus(item.STATUS,item)"> {{SetStatus(item.STATUS)}}</span>



                                </td>
                                <td class="my-td ">{{item.CREATETIME}}</td>
                                <td class="my-td ">


                                    <button type="button" class="btn bg-primary  btn-xs" v-on:click="View(item)">详情</button>
                                    &nbsp;
                                    <button type="button" class="btn bg-purple  btn-xs " v-on:click="Dispose(item)">处理</button>
                                    &nbsp;
                                    <button type="button" class="btn bg-teal  btn-xs" v-on:click="Att(item)">附件</button>



                                </td>
                            </tr>

                        </tbody>
                    </table>
                </div>
                <!-- /.box-body -->


                <div class="box-footer no-padding">
                    <div class="card-footer clearfix pull-left" style="margin-left:20px;margin-top:30px;margin-bottom:30px">

                    </div>

                    <div class="card-footer clearfix pull-right " style="margin-right:30px;margin-top:30px;margin-bottom:30px" id="div_page">

                        <ul class="pagination pagination-sm no-margin pull-right" id="ul_page">
                        </ul>
                    </div>


                    <!-- /.pull-right -->
                </div>
            </div>




            <div class="modal fade" id="modal-default">
                <div class="modal-dialog" style="width:700px">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <h4 class="modal-title" id="txt_username">详情</h4>
                        </div>
                        <div class="modal-body">

                            <form class="form-horizontal">

                                <div class="form-group">
                                    <label for="txt_projectname" class="col-sm-2 control-label">标题：</label>

                                    <div class="col-sm-7">
                                        <input type="text" class="form-control" id="txt_Title" v-model="supprotInfo.TITLE">
                                    </div>
                                </div>


                                <div class="form-group">
                                    <label for="txt_kehuname" class="col-sm-2 control-label">创建人：</label>

                                    <div class="col-sm-7">
                                        <input type="text" class="form-control" v-model="supprotInfo.CREATORNAME" readonly="readonly">
                                    </div>
                                </div>



                                <div class="form-group">
                                    <label for="txt_kehuname" class="col-sm-2 control-label">处理人：</label>

                                    <div class="col-sm-7">
                                        <input type="text" class="form-control" v-model="supprotInfo.CONDUCTORNAME" readonly="readonly">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="txt_address" class="col-sm-2 control-label">项目名称：</label>

                                    <div class="col-sm-7">
                                        <input type="text" class="form-control" v-model="supprotInfo.PROJECTNAME" readonly="readonly">
                                    </div>
                                </div>


                                <div class="form-group">
                                    <label for="txt_address" class="col-sm-2 control-label">内容：</label>

                                    <div class="col-sm-10 pull-right">
                                        <textarea class="form-control" style="height:250px" id="txt_remarks"></textarea>
                                    </div>

                                </div>




                            </form>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>

                            <button type="button" class="btn  btn-primary pull-right">去处理</button>
                            &nbsp;
                            <button type="button" class="btn  btn-primary pull-right" @@click="ChangeContent()" >修 改</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
            </div>



        </div>


    </div>
    <!-- /.col -->
    <!-- /.row -->



</section>

<!-- Control Sidebar -->

<div class="wui-masked" style="position:fixed;background:#fff;top:0;left:0;right:0;bottom:0;z-index:9998;opacity:0.3;display:none;"
     onclick="closeWui()"></div>


<div class="wui-ilayout" style="position:absolute; position:fixed;top:0;right:0;z-index:9999;bottom:0;border-left:4px #eee solid;display:none;background:#fff;">
    <div style="padding:2em;height:100%;background-color:gainsboro">
        <iframe style="width:50%;border:0 none;height:100%;width:100%;" src="about:blank" onload="javascript:$('.wui-ilayout-loading').remove()"></iframe>
    </div>
</div>





<!-- /.control-sidebar -->
@section scripts{

    <script src="~/Reference/adminLTE/bower_components/ckeditor/ckeditor.js"></script>
    <script src="~/Reference/scripts/jquery.form.min.js"></script>


    <script src="~/Reference/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="~/Reference/bootstrap-datetimepicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>

    <script>
        var ck;

        var vm = new Vue({
            el: "#tab_account",
            data: {
                list: [],
                pageIndex: 1,
                pageSize: 15,
                pageCount: 20,
                TotalCount: 0,
                Typelist: [],
                Prioritylist: [],
                Severitylist: [],
                Statuslist: [],
                supprotInfo: {},
                orderby: "SID",
                watchType:0
            },
            created: function () {

                this.Init();


            },
            mounted: function () {

                this.Typelist.push({ value: 0, text:"操作调试"});
                this.Typelist.push({ value: 1, text: "来料质量" });
                this.Typelist.push({ value: 2, text: "商务问题" });
                this.Typelist.push({ value: 3, text: "设计问题" });
                this.Typelist.push({ value: 4, text: "装配误差" });

                this.Prioritylist.push({ value: 0, text: "紧急" });
                this.Prioritylist.push({ value: 1, text: "高" });
                this.Prioritylist.push({ value: 2, text: "中" });
                this.Prioritylist.push({ value: 3, text: "低" });

                this.Statuslist.push({ value: 0, text: "已提交" });
                this.Statuslist.push({ value: 1, text: "处理中(PMC跟进)" });
                this.Statuslist.push({ value: 2, text: "已处理(无需PMC)" });
                this.Statuslist.push({ value: 3, text: "待审核" });
                this.Statuslist.push({ value: 4, text: "已完成" });
                this.Statuslist.push({ value: 5, text: "已拒绝" });

                this.Severitylist.push({ value: 0, text: "致命" });
                this.Severitylist.push({ value: 1, text: "严重" });
                this.Severitylist.push({ value: 2, text: "一般" });
                this.Severitylist.push({ value: 3, text: "提示" });
                this.Severitylist.push({ value: 4, text: "建议" });



                 ck = CKEDITOR.replace('txt_remarks', {
                    height: 250
                });

               



            },
            methods: {

               Init() {

                   var self = this;
                   var keywork = $("#txt_Search").val();

                   console.log("请求数据：" + keywork);


                   MyAjax({
                       url: "/Support/List",
                       type: "POST",
                       data: {
                           keywords: keywork,
                           pageIndex: self.pageIndex,
                           pageSize: self.pageSize,
                           orderby: self.orderby,
                           watchType: self.watchType
                       },
                       success: function (result) {

                          console.log(JSON.stringify(result));

                           if (!result.Success) {

                               alert_danger(result.Message);
                               return;
                           }

                           self.list = result.Content;



                           self.pageIndex = result.PageIndex;
                           self.pageSize = result.PageSize;
                           self.pageCount = result.PageCount;
                           self.pageCount = result.PageTotal;

                           self.PageBind();
                       }
                   })
               },

               Search: function () {
                   pageIndex = 1;
                   this.Init();
               },
               PageBind: function () {
                   var self = this;

                   console.log()

                   $("#ul_page").jqPaginator({
                       totalPages: self.pageCount,
                       visiblePages: self.pageSize,
                       currentPage: self.pageIndex,

                       first: ' <li><a href="#">First</a></li>',
                       prev: ' <li><a href="#">&laquo;</a></li>',
                       next: ' <li><a href="#">&raquo;</a></li>',
                       last: '<li><a href="#">Last<\/a><\/li>',
                       page: '<li><a href="javascript:void(0);">{{page}}<\/a><\/li>',

                       onPageChange: function (num, type) {

                           self.pageIndex = num;

                           if (type == "change") {
                               self.Init();
                           }
                       }
                   });
               },
               ExportExcel: function () {
                   var keyword = $("#txt_Search").val();
                   window.location = "/Support/ExportExcel?keyword=" + keyword;
               },
               Add: function () {

                   window.location.href = "/Support/Create";
                },
               Update: function (item) {

                   var _self = this;
                   MyAjax({
                       url: "/Support/Update",
                       type: "POST",
                       data: item,
                       success: function (result) {

                           console.log(JSON.stringify(result));

                           if (!result.Success) {

                               alert_danger(result.Message);
                               return;
                           }
                           alert_success("修改成功！");

                           _self.Init();
                       }
                   })
                },
               View: function (item) {
                    this.supprotInfo = item;
                    ck.setData(this.supprotInfo.CONTENT);
                    $('#modal-default').modal('show');

                },
               SetSeverity: function (value) {
                   var res = "";
                   this.Severitylist.forEach(function (element) {
                       if (element.value == value) {
                           res = element.text;
                       }
                   });
                   return res;

               },
               SetType: function (value) {

                   var res = "";
                   this.Typelist.forEach(function (element) {
                       if (element.value == value) {
                           res = element.text;
                       }
                   });
                   return res;

               },
               SetPriority(value) {
                   var res = "";
                   this.Prioritylist.forEach(function (element) {
                       if (element.value == value) {
                           res = element.text;
                       }
                   });
                   return res;

               },
               SetStatus(value) {

                   var res = "";
                   this.Statuslist.forEach(function (element) {
                       if (element.value == value) {
                           res = element.text;
                       }
                   });
                   return res;
               },
               ChangeType(value,item) {
                   var _self = this;

                   bootbox.prompt({
                       size: "small",
                       title: "问题类型",
                       inputType: "select",
                       value: value,
                       inputOptions: _self.Typelist,
                       callback: function (result) {

                           if (result == null) {
                               return;
                           }
                           item.TYPE = result;
                           _self.Update(item);


                       }
                   });
                },

                ChangeStatus(value, item) {
                    var _self = this;

                    bootbox.prompt({
                        size: "small",
                        title: "工单状态",
                        inputType: "select",
                        value: value,
                        inputOptions: [{ value: 4, text: "已完成" }, { value: 5, text: "已拒绝" }],
                        callback: function (result) {

                            if (result == null) {
                                return;
                            }
                            item.STATUS = result;
                            _self.Update(item);

                        }
                    });
                },

                ChangePriority(value, item) {
                    var _self = this;

                    bootbox.prompt({
                        size: "small",
                        title: "工单状态",
                        inputType: "select",
                        value: value,
                        inputOptions: _self.Prioritylist,
                        callback: function (result) {

                            if (result == null) {
                                return;
                            }
                            item.PRIORITY = result;
                            _self.Update(item);

                        }
                    });
                },

                ChangeSeverity(value, item) {
                    var _self = this;

                    bootbox.prompt({
                        size: "small",
                        title: "工单状态",
                        inputType: "select",
                        value: value,
                        inputOptions: _self.Severitylist,
                        callback: function (result) {

                            if (result == null) {
                                return;
                            }
                            item.SEVERITY = result;
                            _self.Update(item);

                        }
                    });
                },
                ChangeUser(item) {
                    this.supprotInfo = item;
                    showWui("/Support/FillUser");
                },
                SetUser(item) {

                    console.log(item);

                    var _self = this;
                    _self.supprotInfo.CONDUCTOR = item.USER_ID;
                    _self.supprotInfo.CONDUCTORNAME = item.USER_NAME;

                    _self.Update(_self.supprotInfo);


                    closeWui();

                },
                Dispose(item) {
                    window.location.href = "/Support/Disposer?id=" + item.SID;
                },
                Att(item) {

                    showWui("/Support/Attachment?id=" + item.SID);

                },
                ChangeContent() {

                    this.supprotInfo.CONTENT = ck.getData();
                    this.Update(this.supprotInfo);

                }
           },



       });


    </script>

}
